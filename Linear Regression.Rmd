---
title: "Week 2: Exercise"
author: "Joel Konitzer"
date: '2022-07-10'
output:
  pdf_document: default
  html_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# load the data.table, ggolot2, and dplyr libraries
library('ggplot2')
library('dplyr')
library('stargazer')
```

#### Introduction 

This exercise aims to demonstrate how to evaluate a linear regression model using the statistical programming software, R. The data used to demonstrate this process is housing market data sourced from Zillow. The analyzed features of interest are Price, Longitude, Latitude, and Tax Dollar Value; however, the regression is performed on Price and Longitude. Itâ€™s important to note that this data is not cleaned, so data transformations are demonstrated before the regression. 
```{r}
# Load data
dt <- read.csv("./Homework/data_week3.csv")
```

```{r}
# EDA ---------------------------------------------------------------------
# Check the structure
dim(dt)
str(dt)

#Drop record_date column
dt <- dt[-c(1)]

#View summary statistics, value distribution, and outlier detection
summary(dt)
hist(dt$revenue)
plot(density(dt$revenue,na.rm=TRUE), main = "Revenue value distribution")
boxplot(dt$revenue)

# Remove the outliers from Revenue
# Select upper & lower quartiles to assign as outliers
quartiles <- quantile(dt$revenue, probs=c(.25, .75), na.rm = FALSE)
IQR <- IQR(dt$revenue, na.rm = TRUE)
Lower <- quartiles[1] - 1.5*IQR
Upper <- quartiles[2] + 1.5*IQR
dt_clean <- subset(dt, dt$revenue > Lower & dt$revenue < Upper)
dt_clean <- dt_clean[dt$revenue > 0, ]

#Remove NAs
dt_clean <- dt_clean[complete.cases(dt_clean),]
dim(dt_clean)

#Confirm outliers were removed
#Outliers are still present, but lets see how the regression turns out
boxplot(dt_clean$revenue)

#View data shape after removing outliers & calculate amount removed
dim(dt_clean)
outliers_removed <- nrow(dt) - nrow(dt_clean)
outliers_removed
```


```{r}
# Handle outliers
# Create a boxplot of the price data
par(mfrow = c(2,1))
#Creating boxplot to view value spread
boxplot(df_n$price, main = "Price value distribution")
#Creating density to view data distribution
plot(density(df_n$price,na.rm=TRUE), main = "Price value distribution")
```

#### Methods 

The dataset features were analyzed using native R functions and multiple regression literature to assess model performance. Outlier effects can significantly influence model performance, so outliers were removed from the Revenue column using the IQR zone as a reference, illustrated in the boxplots below. Any non-integer values were also removed from the dataset as they cause R to throw an error upon code execution. One regression was performed using highly correlated features based on results from a correlation matrix generated by the Corrplot() function from the Corrplot library. Native R functions were used to analyze the regression results listed at the beginning of this analysis and before code executions. 

```{r}
# View Correlations -------------------------------------------------------
# Plot a correlation matrix
par(mfrow=c(1,1))
library(corrplot)
corrplot(cor(dt_clean), method='number')
```   

#### Results

The results from this exercise suggest there is little to no correlation between housing price and longitude, with a correlation of 0.036. With this result, it may be safe to assume that the elevation at which a house is bought does not play a significant role in the price. The exercise went as expected, which I attribute to it being a relatively simple example to demonstrate. Better model performance was achieved using the dataset without outliers and was confirmed through the result values and the diagnostic plots below. Taking the QQ plots as an example, the data points for the plot without outliers fall more on the line than the one without; this suggests the dataset without outliers follows a more normal distribution which is what a regression model requires to perform well. 
	
	
###### With outliers
```{r}
# Run regression ----------------------------------------------------------
### Linear Model ###
# Fit linear model to quality and all variables
fit <- lm(revenue ~ ., data = dt_clean)
summary(fit)
plot(fit)

## Check Assumptions ## 
# View the summary, VIF, and residual plots of the fit
vif(fit)
AIC(fit)
```   



```{r}

# Created reduced model -------------------------------------------------------

dt_reduced <- dt_clean
columns_new <- c('revenue','cost','hours_actual','company_count')
dt_reduced <- subset(dt_reduced, select = columns_new)


newfit <- lm(revenue ~ cost + hours_actual + company_count, data = dt_reduced)
summary(newfit)
plot(newfit)
AIC(newfit)

library(MASS)
stepAIC(newfit, direction = 'both')
stepAIC(fit, direction = 'both')
``` 

#### Conclusion

This exercise allows for a careful and considerate walk through the regression process by using housing data to find correlations between data features and price. The results showed that terrain features play less of a role in housing prices than other attributes. Additionally, this exercise highlighted the importance of proper data transformations before fitting and plotting the model. In future analysis, it may be important to consider other data transformation techniques, such as imputations on NA columns as average, instead of completely removing them. 

